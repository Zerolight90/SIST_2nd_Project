<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="payment">

    <resultMap id="paymentResultMap" type="mybatis.vo.PaymentVO" autoMapping="true">
        <id property="paymentIdx" column="paymentIdx"/>
    </resultMap>

    <insert id="addPayment" parameterType="mybatis.vo.PaymentVO" useGeneratedKeys="true" keyProperty="paymentIdx">
        INSERT INTO payment
        (
            userIdx, reservationIdx, productIdx, orderId, paymentTransactionId,
            paymentQuantity, paymentMethod, paymentTotal, paymentDiscount, paymentFinal,
            paymentType, paymentStatus, paymentDate
        )
        VALUES
            (
                #{userIdx}, #{reservationIdx}, #{productIdx}, #{orderId}, #{paymentTransactionId},
                #{paymentQuantity}, #{paymentMethod}, #{paymentTotal}, #{paymentDiscount}, #{paymentFinal},
                #{paymentType}, 0, NOW()
            )
    </insert>

    <update id="updatePaymentStatusAndCancelDate" parameterType="map">
        UPDATE payment
        SET
            paymentStatus = #{paymentStatus},       -- 0: 완료, 1: 취소
            paymentCancelDate = #{paymentCancelDate}
        WHERE
            paymentTransactionId = #{paymentKey}    -- 토스 API 거래 ID
    </update>

    <select id="getAllPayments" resultMap="paymentResultMap">
        SELECT *
        FROM payment
        ORDER BY paymentDate DESC
    </select>

    <select id="getPaymentsByUserIdx" parameterType="long" resultMap="paymentResultMap">
        SELECT *
        FROM payment
        WHERE userIdx = #{userIdx}
        ORDER BY paymentDate DESC
    </select>
</mapper>