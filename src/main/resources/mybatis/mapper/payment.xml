<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="payment">
    <insert id="addPayment" parameterType="mybatis.vo.PaymentVO">
        INSERT INTO Payment
        (
            userIdx, reservationIdx, productIdx, orderId, paymentTransactionId,
            paymentQuantity, paymentMethod, paymentTotal, paymentDiscount, paymentFinal,
            paymentType, paymentStatus, paymentDate
        )
        VALUES
            (
                #{userIdx}, #{reservationIdx}, #{productIdx}, #{orderId}, #{paymentTransactionId},
                #{paymentQuantity}, #{paymentMethod}, #{paymentTotal}, #{paymentDiscount}, #{paymentFinal},
                #{paymentType},    0,                 NOW()              )
    </insert>

    <update id="updatePaymentStatusAndCancelDate" parameterType="map">
        UPDATE Payment
        SET
            paymentStatus = #{paymentStatus},       -- 0: 완료, 1: 취소
            paymentCancelDate = #{paymentCancelDate}
        WHERE
            paymentTransactionId = #{paymentKey}    -- 토스 API 거래 ID
    </update>

    <select id="getAllPayments" resultType="mybatis.vo.PaymentVO">
        SELECT
            paymentIdx, paymentType, userIdx, reservationIdx, productIdx, orderId, paymentTransactionId,
            paymentQuantity, paymentMethod, paymentTotal, paymentDiscount, paymentFinal,
            paymentStatus, paymentDate, paymentCancelDate
        FROM Payment
        ORDER BY paymentDate DESC
    </select>

    <select id="getPaymentsByUserIdx" parameterType="long" resultType="mybatis.vo.PaymentVO">
        SELECT
            paymentIdx, paymentType, userIdx, reservationIdx, productIdx, orderId, paymentTransactionId,
            paymentQuantity, paymentMethod, paymentTotal, paymentDiscount, paymentFinal,
            paymentStatus, paymentDate, paymentCancelDate
        FROM Payment
        WHERE userIdx = #{userIdx}
        ORDER BY paymentDate DESC
    </select>
</mapper>