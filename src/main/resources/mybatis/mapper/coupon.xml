<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="coupon">

    <resultMap id="myCouponResultMap" type="mybatis.vo.MyCouponVO">
        <result property="couponUserIdx" column="couponUserIdx"/>
        <result property="couponName" column="couponName"/>
        <result property="couponValue" column="couponValue"/>
    </resultMap>

    <select id="getAvailableCoupons" parameterType="long" resultMap="myCouponResultMap">
        SELECT
            cum.couponUserIdx,
            c.couponName,
            c.couponValue
        FROM
            CouponUserMapping cum
                JOIN
            Coupon c ON cum.couponIdx = c.couponIdx
        WHERE
            cum.userIdx = #{userIdx}
          AND cum.couponUserStatus = 0 -- 0: 미사용
          AND c.couponExpDate >= NOW()
    </select>

    <update id="useCoupon" parameterType="int">
        UPDATE CouponUserMapping
        SET couponUserStatus = 1, -- 1: 사용 완료
            couponUserDate = NOW()
        WHERE couponUserIdx = #{couponUserIdx}
    </update>

</mapper>